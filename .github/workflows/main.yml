name: Build OnePlus 11 Kernel (方案F - 改进版)

# 改进点:
# 1. 使用官方 KernelSU setup.sh 脚本
# 2. 正确的 SuSFS 集成方式
# 3. 使用参考内核的 anykernel.sh 结构
# 4. 版本号强制修复

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng libssl-dev bc libc6-dev-i386 libncurses5-dev lib32z1-dev libx11-dev xsltproc unzip device-tree-compiler python3 libelf-dev dwarves

    - name: Download Neutron Clang
      run: |
        mkdir -p clang
        cd clang
        bash <(curl -s "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman") -S
        echo "PATH=$PWD/bin:$PATH" >> $GITHUB_ENV

    - name: Clone Kernel Source
      run: |
        git clone --depth=1 https://github.com/crdroidandroid/android_kernel_oneplus_sm8550 -b 14.0 android-kernel
        cd android-kernel
        echo "KERNEL_DIR=$PWD" >> $GITHUB_ENV

    - name: Setup KernelSU (官方方法)
      run: |
        cd android-kernel
        echo ">>> 使用官方 KernelSU setup.sh 脚本..."
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
        
        # 获取 KSU 版本
        KSU_VERSION=$(cd KernelSU && expr $(/usr/bin/git rev-list --count HEAD) + 10200)
        echo ">>> KernelSU version: $KSU_VERSION"
        echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV

    - name: Setup SuSFS
      run: |
        cd android-kernel
        echo ">>> 集成 SuSFS..."
        
        # 下载 SuSFS 补丁
        git clone -b gki-android13-5.15 https://gitlab.com/simonpunk/susfs4ksu.git
        
        # 复制 SuSFS 源文件
        cp susfs4ksu/kernel_patches/fs/susfs.c fs/
        cp susfs4ksu/kernel_patches/include/linux/susfs.h include/linux/
        cp susfs4ksu/kernel_patches/include/linux/susfs_def.h include/linux/
        
        # 应用 SuSFS 补丁
        echo ">>> 应用 SuSFS kernel 补丁..."
        SUSFS_PATCH=$(find susfs4ksu/kernel_patches -maxdepth 1 -name "50_add_susfs*.patch" | head -1)
        if [ -n "$SUSFS_PATCH" ]; then
            echo "Found patch: $SUSFS_PATCH"
            patch -p1 < "$SUSFS_PATCH" || echo "Patch may have conflicts"
        fi
        
        # 应用 KernelSU 的 SuSFS 支持补丁
        KSU_SUSFS_PATCH=$(find susfs4ksu/kernel_patches -maxdepth 1 -name "*.patch" | grep -v "50_add_susfs" | head -1)
        if [ -n "$KSU_SUSFS_PATCH" ]; then
            echo "Found KSU SuSFS patch: $KSU_SUSFS_PATCH"
            cd KernelSU
            patch -p1 < "../$KSU_SUSFS_PATCH" || echo "KSU patch may have conflicts"
            cd ..
        fi

    - name: Configure Kernel
      run: |
        cd android-kernel
        export ARCH=arm64
        export SUBARCH=arm64
        
        echo ">>> [方案F] 改进版构建..."
        
        # 生成基础配置
        make O=out gki_defconfig
        
        # 合并所有官方配置
        for cfg in \
            "arch/arm64/configs/vendor/kalama_GKI.config" \
            "arch/arm64/configs/vendor/oplus/kalama_GKI.config" \
            "arch/arm64/configs/vendor/oplus/salami.config" \
            "arch/arm64/configs/vendor/debugfs.config"; do
            if [ -f "$cfg" ]; then
                echo ">>> Merging: $cfg"
                ./scripts/kconfig/merge_config.sh -m -O out out/.config "$cfg"
            fi
        done
        
        # KernelSU 配置
        ./scripts/config --file out/.config --enable KSU
        
        # SuSFS 配置
        ./scripts/config --file out/.config --enable KSU_SUSFS
        ./scripts/config --file out/.config --enable KSU_SUSFS_SUS_PATH
        ./scripts/config --file out/.config --enable KSU_SUSFS_SUS_MOUNT
        ./scripts/config --file out/.config --enable KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
        ./scripts/config --file out/.config --enable KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
        ./scripts/config --file out/.config --enable KSU_SUSFS_SUS_KSTAT
        ./scripts/config --file out/.config --enable KSU_SUSFS_SUS_OVERLAYFS
        ./scripts/config --file out/.config --enable KSU_SUSFS_TRY_UMOUNT
        ./scripts/config --file out/.config --enable KSU_SUSFS_SPOOF_UNAME
        ./scripts/config --file out/.config --enable KSU_SUSFS_ENABLE_LOG
        ./scripts/config --file out/.config --enable KSU_SUSFS_OPEN_REDIRECT
        ./scripts/config --file out/.config --enable KSU_SUSFS_SUS_MAP
        
        # 基础功能
        ./scripts/config --file out/.config --enable OVERLAY_FS
        ./scripts/config --file out/.config --enable MODULES
        ./scripts/config --file out/.config --enable KPROBES
        ./scripts/config --file out/.config --enable HAVE_KPROBES
        ./scripts/config --file out/.config --enable KPROBE_EVENTS
        
        # LTO 设置
        ./scripts/config --file out/.config --enable LTO
        ./scripts/config --file out/.config --enable LTO_CLANG
        ./scripts/config --file out/.config --enable LTO_CLANG_FULL
        ./scripts/config --file out/.config --disable LTO_CLANG_THIN
        ./scripts/config --file out/.config --disable LTO_NONE
        
        # DEBUG_INFO 设置 (增加内核大小)
        ./scripts/config --file out/.config --enable DEBUG_INFO
        ./scripts/config --file out/.config --enable DEBUG_INFO_BTF
        
        # ★★★ 关键：强制版本号匹配官方 ★★★
        echo ">>> CRITICAL: Forcing kernel version..."
        ./scripts/config --file out/.config --disable LOCALVERSION_AUTO
        ./scripts/config --file out/.config --set-str LOCALVERSION "-gc1e512cfc3eb"
        
        make O=out olddefconfig
        
        # 验证配置
        echo ">>> Final config verification:"
        grep -E "CONFIG_KSU=|CONFIG_LOCALVERSION=|CONFIG_LTO_CLANG_FULL=" out/.config

    - name: Build Kernel
      run: |
        cd android-kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
        export CC=clang
        
        echo ">>> Building kernel..."
        make -j$(nproc --all) O=out LLVM=1 LLVM_IAS=1 Image dtbs
        
        # 验证编译结果
        if [ -f "out/arch/arm64/boot/Image" ]; then
            echo ">>> Kernel compiled successfully!"
            ls -la out/arch/arm64/boot/Image
            
            # 提取版本字符串验证
            echo ">>> Verifying kernel version string:"
            strings out/arch/arm64/boot/Image | grep -m1 "Linux version" || echo "Version extraction failed"
        else
            echo ">>> ERROR: Kernel compilation failed!"
            exit 1
        fi

    - name: Package with AnyKernel3 (参考版)
      run: |
        git clone https://github.com/osm0sis/AnyKernel3 --depth=1
        cd AnyKernel3
        
        # 使用改进的 anykernel.sh (参考成功内核的结构)
        cat > anykernel.sh << 'ANYKERNEL_EOF'
### AnyKernel3 Ramdisk Mod Script
## osm0sis @ xda-developers

### AnyKernel setup
# global properties
properties() { '
kernel.string=KernelSU-SuSFS for OnePlus 11 crDroid v10.13
do.devicecheck=0
do.modules=0
do.systemless=0
do.cleanup=1
do.cleanuponabort=0
device.name1=
device.name2=
device.name3=
device.name4=
device.name5=
supported.versions=
supported.patchlevels=
supported.vendorpatchlevels=
'; } # end properties


### AnyKernel install
## boot shell variables
block=boot
is_slot_device=auto
ramdisk_compression=auto
patch_vbmeta_flag=auto
no_magisk_check=1

# import functions/variables and setup patching - see for reference (DO NOT REMOVE)
. tools/ak3-core.sh

kernel_version=$(cat /proc/version | awk -F '-' '{print $1}' | awk '{print $3}')
case $kernel_version in
    5.1*) ksu_supported=true ;;
    6.1*) ksu_supported=true ;;
    *) ksu_supported=false ;;
esac

ui_print " " "  -> ksu_supported: $ksu_supported"
$ksu_supported || abort "  -> Non-GKI device, abort."

# boot install
if [ -L "/dev/block/bootdevice/by-name/init_boot_a" -o -L "/dev/block/by-name/init_boot_a" ]; then
    split_boot # for devices with init_boot ramdisk
    flash_boot # for devices with init_boot ramdisk
else
    dump_boot # use split_boot to skip ramdisk unpack, e.g. for devices with init_boot ramdisk
    write_boot # use flash_boot to skip ramdisk repack, e.g. for devices with init_boot ramdisk
fi
## end boot install
ANYKERNEL_EOF
        
        rm -rf ramdisk modules patch .git* README.md
        mkdir -p modules
        cp ../android-kernel/out/arch/arm64/boot/Image .
        zip -r9 ../OnePlus11-Kernel-F-Improved.zip . -x '*.git*'

    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus11-Kernel-F-Improved-KSU${{ env.KSU_VERSION }}
        path: OnePlus11-Kernel-F-Improved.zip
        if-no-files-found: warn
